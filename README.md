# PanSVMerger-A-Pipeline-for-Merging-Multi-Allele-Structural-Variants
## About

SV-Merger is a bioinformatics pipeline designed to merge multi-allele structural variants (SVs) located at the same genomic position based on their length and sequence similarity. This tool aims to provide a reliable and efficient method for consolidating SV data, which is crucial for accurate genomic analysis and interpretation

## Pipeline Description
- vcfwave to decompose SVs from VCF generated by MC
- vcfcreatemulti to remove overlapping and nested alleles
- vsearch to cluster and finally merge alleles
- updata genotype, AC, AF information for each allele

## Requirements and Install
- [vcflib](https://github.com/vcflib/vcflib)
- [pysam](https://github.com/pysam-developers/pysam) (stable version)
- vsearch

## Usage
### Prepare non-overlapping multiallelic VCF file
Due to the complexity of variants called from graph, particulally those complex regions with nested bubbles, VCF file genereated by MC still contains tricky and problematic sites although after "poping" using `vcfbubble`. [As Garrison et al. suggested](https://github.com/vcflib/vcflib/blob/master/doc/vcfwave.md), we should first realign reference and alternate alleles to parse out the original "primitive" alleles into multiple records and next put them together again, which would be provided for `SV-Merger` to consolidate SVs based on similarity and length (see below).
```
vcfwave -t16 MC.vcf.gz (-L 100000) > MC.wave.vcf ## you can ignore SVs longer than 100Kb
bcftools norm --threads 16 -m- MC.wave.vcf -Ov -o MC.wave.bi.vcf ## there are still few multiallelic sites
vcfcreatemulti MC.wave.bi.vcf > MC.wave.bi.createmulti.vcf
```

### Merge SVs
After removing and reconstructing overlapping and nested sites, we would see multiple alleles in one complex SV record. However, they might be slightly different and should be considered as the same one, which would have great impacts on downstream analysis. Therefore, we'd like to consolidate and merge them to confident consensus. [See our paper for detailed methods.](https://github.com/tingting100/PanSVMerger#citation)
```
python SV.merge_variants.py MC.wave.bi.createmulti.vcf MC.wave.bi.createmulti.merge -t 16 ## if input compressed vcf file, please index first
bgzip -@16 MC.wave.bi.createmulti.merge.vcf ## if input compressed file, `SV.merge_variants.py` will output compressed merged vcf file
bcftools index -t --threads 16 MC.wave.bi.createmulti.merge.vcf.gz
```

## Parameters
```

```




## Output


## some useful tools
### convert between phased diploid vcf and haploid vcf


## Citation



Xxx



## Help



If you get any problems, please raise an [issue](https://github.com/tingting100/PanSVMerger/issues) first. For another helps, please contact xxx and quanyu_chen@outlook.com.



## TO-DO-LIST

- consider make most of parameters accessible, such as 
  - length threshold for grouping or make is as an dynamic setting which depends on allele length; 
  - the vsearch path, the main parameters of vsearch, like threads, cluster mode,
    - (paritally) done (quanyu)
  - for clustering very long or large sequences, consider to use [HAlign](https://github.com/malabz/HAlign-3)
  - 

- faster IO? using other method to read or write VCF files? [PyVCF](https://github.com/jamescasbon/PyVCF)
  - I will use `pysam` to edit vcf records more efficiently. (quanyu)
    - done

- Add some modules for statistics or visualization
  - basic statistics
    - Fst?
  - histogram for AC before and after clustering

- other problem
  - whether should consider the direction of alignment, for example, in a clustered group, one sequence aligns with inverted direction, how to deal with it?
  - 
