# PanSVMerger-A-Pipeline-for-Merging-Multi-Allele-Structural-Variants
# Table of Contents

1. [About](#About)
   - [Pipeline Description](#Pipeline Description)
   - [why-PanSVMerge](#why-PanSVMerge)
   - [Requirements and Install](#Requirements and Install)

2. [Usage](#usage)
   - [Annotate TR sequences](#annotate-tr-sequences)
   - [Generate simulated TR sequences](#generate-simulated-tr-sequences)
   - [Create reference motifset](#create-reference-motifset)
   - [Evaluate annotation quality](#evaluate-annotation-quality)
   - [Refine annotation](#refine-annotation)

3. [Visualization](#visualization)
   - [Plotting sequence logos to visualize motif variation](#plotting-sequence-logos-to-visualize-motif-variation)
   - [Calculate identity matrix](#calculate-identity-matrix)

4. [Support](#support)
   - [Getting Help](#getting-help)
   - [Citing VAMPIRE](#citing-vampire)
   - 
## About

SV-Merger is a bioinformatics pipeline designed to merge multi-allele structural variants (SVs) located at the same genomic position based on their length and sequence similarity. This tool aims to provide a reliable and efficient method for consolidating SV data, which is crucial for accurate genomic analysis and interpretation

## Pipeline Description
- vcfwave to decompose SVs from VCF generated by MC
- vcfcreatemulti to remove overlapping and nested alleles
- vsearch to cluster and finally merge alleles
- updata genotype, AC, AF information for each allele

## Requirements and Install
- [vcflib](https://github.com/vcflib/vcflib)
- [pysam](https://github.com/pysam-developers/pysam) (stable version)
- vsearch

## Usage
### Prepare non-overlapping multiallelic VCF file
Due to the complexity of variants called from graph, particulally those complex regions with nested bubbles, VCF file genereated by MC still contains tricky and problematic sites although after "poping" using `vcfbubble`. [As Garrison et al. suggested](https://github.com/vcflib/vcflib/blob/master/doc/vcfwave.md), we should first realign reference and alternate alleles to parse out the original "primitive" alleles into multiple records and next put them together again, which would be provided for `SV-Merger` to consolidate SVs based on similarity and length (see below).
```
vcfwave -t16 MC.vcf.gz (-L 100000) > MC.wave.vcf ## you can ignore SVs longer than 100Kb
bcftools norm --threads 16 -m- MC.wave.vcf -Ov -o MC.wave.bi.vcf ## there are still few multiallelic sites
vcfcreatemulti MC.wave.bi.vcf > MC.wave.bi.createmulti.vcf
```

### Merge SVs
After removing and reconstructing overlapping and nested sites, we would see multiple alleles in one complex SV record. However, they might be slightly different and should be considered as the same one, which would have great impacts on downstream analysis. Therefore, we'd like to consolidate and merge them to confident consensus. [See our paper for detailed methods.](https://github.com/tingting100/PanSVMerger#citation)
```
python SV.merge_variants.py MC.wave.bi.createmulti.vcf MC.wave.bi.createmulti.merge -t 16 ## if input compressed vcf file, please index first
bgzip -@16 MC.wave.bi.createmulti.merge.vcf ## if input compressed file, `SV.merge_variants.py` will output compressed merged vcf file
bcftools index -t --threads 16 MC.wave.bi.createmulti.merge.vcf.gz
```

### Contacts
(yangting@genomics.cn)
(yangchentao@genomics.cn)
(quanyu_chen@outlook.com)
